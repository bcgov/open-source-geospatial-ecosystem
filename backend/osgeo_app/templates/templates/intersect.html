<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitanyow Lax’yip Planning Objective Feature Intersect</title>
    <link rel="stylesheet" href="../static/style.css">
    <style>
        /* Loading Spinner Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing intersection...<br>Please wait</div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://apps.gov.bc.ca/pub/geomark/js/geomark.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.4/wicket.min.js"></script>
<!-- Header Section -->

<div class="header">
    <img src="../static/BCID_H_rgb_rev.png"                    // Add checkbox for togglin                    // Add checkbox for toggling
                    addLayerCheckbox('Intersected Legal Points', legalPointsLayer, '#800080');                    addLayerCheckbox('Intersected Legal Lines', legalLinesLayer, '#008000');lt="British Columbia Logo" class="logo">
    <div class="title">Gitanyow Lax’yip Land Use Planning Tool</div>
    <div class="navbar">
        <div class="dropdown">
            <button class="dropbtn">Data & Mapping Tools </button>
            <div class="dropdown-content">
                <a href="./">Main Page</a>
                <a href="./overview_map">Overview Map</a>
                <a href="./intersect">Intersect Data</a>
            </div>
            </div>
    </div>
</div>

<!-- Top Banner -->
<div class="banner">
    <div class="banner-title"><p>Intersect Tool</p></div>
</div>

    <!-- Contains the Layer Selection Checkboxes and Legend Collapsible Menus-->
    <div class="collapsible-bar">
        <!-- back button-->
        <div>
            <button onclick="window.location.href='/'" class="back-button">Return to Main Page</button>
        </div>
        <!--Layer Selection-->
        <div>
            <button class="collapsible">Select Layers</button>
            <div class="content" id="checkbox-container">
                <p style="font-size: larger;"><br><strong>Select Map Layers</strong></p>
            </div>
        </div>
    </div>

    <h2>Upload a File to Intersect with Legal and Non Legal Planning Objectives</h2>
        <div class="tool-note">
        <strong>Note:</strong>
        <p>
            This tool queries only the non-legal and legal polygon layers, which represent the majority of GLLUP values. Please be aware that additional values,<br> such as cultural and archaeological information, may exist in other datasets and are <strong>not</strong> included in these results.<br>
        </p>
    </div>
    <!-- Form for uploading data -->
    <form action="/intersect" method="POST" enctype="multipart/form-data" class="form-horizontal">
        <div>
            <label for="file-upload">Upload a file:</label>
            <input type="file" id="file-upload" name="file" accept=".geojson,.zip,.kml,.gpx">
        </div>
        <div>
            <label for="url-input">Or a geomark URL:</label>
            <input type="url" id="url-input" name="url" placeholder="Enter URL">
        </div>
        <div class="radio-group">
            <label>
                <input type="radio" name="data_type" value="legal" required> Legal
            </label>
            <label>
                <input type="radio" name="data_type" value="non_legal"> Non-legal
            </label>
            <label>
                <input type="radio" name="data_type" value="both"> Both
            </label>
        </div>
        <button type="submit">Upload and Intersect</button>
    </form>

    <section class='maps'>
        <div class='maps-box'>
            <div id='maps-item'>
                <!-- Embed leaflet map content -->
                {{ leaflet_map|safe }}
            </div>
        </div>
    </section>

    <!-- Intersected Data Section -->
    <div class="data-section">

        {% if intersected_data_1 %}
            <h3>Legal Planning Objective Polygons</h3>
            <button class="minimize-btn" onclick="toggleTableVisibility('intersected-data-1')">Minimize</button>
            <div id="intersected-data-1" class="table-container">
                <table id="intersected-data-1-table">
                    <thead>
                        <tr>
                            <th>Legal Feature ID</th>
                            <th>Plan Name</th>
                            <th>Objective</th>
                            <th>Legalization Date</th>
                            <th>Legal Feature Attribute 1</th>
                            <th>Legal Feature Attribute Value 1</th>
                            <th>Legal Feature Attribute Value 2</th>
                            <th>Legal Feature Attribute 4</th>
                            <th>Legal Feature Attribute Value 4</th>
                            <th>Legal Feature Attribute Value 5</th>
                            <th>Document Title</th>
                            <th>Document URL</th>
                            <th>Metadata Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in intersected_data_1 %}
                            <tr>
                                <td>{{ row['LEGAL_FEAT_ID'] }}</td>
                                <td>{{ row['STRGC_LAND_RSRCE_PLAN_NAME'] }}</td>
                                <td>{{ row['LEGAL_FEAT_OBJECTIVE'] }}</td>
                                <td>{{ row['LEGALIZATION_DATE'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_1_NAME'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_1_VALUE'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_2_NAME'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_2_VALUE'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_4_NAME'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_4_VALUE'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_5_NAME'] }}</td>
                                <td>{{ row['LEGAL_FEAT_ATRB_5_VALUE'] }}</td>
                                <td>{{ row['ENABLING_DOCUMENT_TITLE'] }}</td>
                                <td><a href="{{ row['ENABLING_DOCUMENT_URL'] }}" target="_blank">Link</a></td>
                                <td><a href="{{ row['RSRCE_PLAN_METADATA_LINK'] }}" target="_blank">Link</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No Legal Planning Objective Polygon data found</p>
        {% endif %}

        {% if intersected_data_2 %}
            <h3>Legal Planning Objective Lines</h3>
            <button class="minimize-btn" onclick="toggleTableVisibility('intersected-data-2')">Minimize</button>
            <div id="intersected-data-2" class="table-container">
                <table id="intersected-data-2-table">
                    <thead>
                        <tr>
                            <th>Legal Feature ID</th>
                            <th>Plan Name</th>
                            <th>Objective</th>
                            <th>Legalization Date</th>
                            <th>Document Title</th>
                            <th>Document URL</th>
                            <th>Metadata Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in intersected_data_2 %}
                            <tr>
                                <td>{{ row['LEGAL_FEAT_ID'] }}</td>
                                <td>{{ row['STRGC_LAND_RSRCE_PLAN_NAME'] }}</td>
                                <td>{{ row['LEGAL_FEAT_OBJECTIVE'] }}</td>
                                <td>{{ row['LEGALIZATION_DATE'] }}</td>
                                <td>{{ row['ENABLING_DOCUMENT_TITLE'] }}</td>
                                <td><a href="{{ row['ENABLING_DOCUMENT_URL'] }}" target="_blank">Link</a></td>
                                <td><a href="{{ row['RSRCE_PLAN_METADATA_LINK'] }}" target="_blank">Link</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No Legal Planning Objective line data found</p>
        {% endif %}

        {% if intersected_data_3 %}
            <h3>Legal Planning Objective Points</h3>
            <button class="minimize-btn" onclick="toggleTableVisibility('intersected-data-3')">Minimize</button>
            <div id="intersected-data-3" class="table-container">
                <table id="intersected-data-3-table">
                    <thead>
                        <tr>
                            <th>Legal Feature ID</th>
                            <th>Plan Name</th>
                            <th>Objective</th>
                            <th>Legalization Date</th>
                            <th>Document Title</th>
                            <th>Document URL</th>
                            <th>Metadata Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in intersected_data_3 %}
                            <tr>
                                <td>{{ row['LEGAL_FEAT_ID'] }}</td>
                                <td>{{ row['STRGC_LAND_RSRCE_PLAN_NAME'] }}</td>
                                <td>{{ row['LEGAL_FEAT_OBJECTIVE'] }}</td>
                                <td>{{ row['LEGALIZATION_DATE'] }}</td>
                                <td>{{ row['ENABLING_DOCUMENT_TITLE'] }}</td>
                                <td><a href="{{ row['ENABLING_DOCUMENT_URL'] }}" target="_blank">Link</a></td>
                                <td><a href="{{ row['RSRCE_PLAN_METADATA_LINK'] }}" target="_blank">Link</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No Legal Planning Objective Points data found</p>
        {% endif %}

        {% if intersected_data_4 %}
            <h3>Non-Legal Planning Objective Polygons</h3>
            <button class="minimize-btn" onclick="toggleTableVisibility('intersected-data-4')">Minimize</button>
            <div id="intersected-data-4" class="table-container">
                <table id="intersected-data-4-table">
                    <thead>
                        <tr>
                            <th>Non Legal Feature ID</th>
                            <th>Plan Name</th>
                            <th>Objective</th>
                            <th>Decision Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in intersected_data_4 %}
                            <tr>
                                <td>{{ row['NON_LEGAL_FEAT_ID'] }}</td>
                                <td>{{ row['STRGC_LAND_RSRCE_PLAN_NAME'] }}</td>
                                <td>{{ row['NON_LEGAL_FEAT_OBJECTIVE'] }}</td>
                                <td>{{ row['ORIGINAL_DECISION_DATE'] }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No Non-Legal Planning Objective Polygon data found</p>
        {% endif %}

        {% if intersected_data_5 %}
        <h3>Non-Legal Planning Objective Lines</h3>
        <button class="minimize-btn" onclick="toggleTableVisibility('intersected-data-5')">Minimize</button>
        <div id="intersected-data-5" class="table-container">
            <table id="intersected-data-5-table">
                <thead>
                    <tr>
                        <th>Non Legal Feature ID</th>
                        <th>Plan Name</th>
                        <th>Objective</th>
                        <th>Decision Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in intersected_data_5 %}
                        <tr>
                            <td>{{ row['NON_LEGAL_FEAT_ID'] }}</td>
                            <td>{{ row['STRGC_LAND_RSRCE_PLAN_NAME'] }}</td>
                            <td>{{ row['NON_LEGAL_FEAT_OBJECTIVE'] }}</td>
                            <td>{{ row['ORIGINAL_DECISION_DATE'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No Non-Legal Planning Objective line data found</p>
    {% endif %}
    </div>

        {% if intersected_data_6 %}
        <h3>Non-Legal Planning Objective Points</h3>
        <button class="minimize-btn" onclick="toggleTableVisibility('intersected-data-6')">Minimize</button>
        <div id="intersected-data-6" class="table-container">
            <table id="intersected-data-6-table">
                <thead>
                    <tr>
                        <th>Non Legal Feature ID</th>
                        <th>Plan Name</th>
                        <th>Objective</th>
                        <th>Decision Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in intersected_data_6 %}
                        <tr>
                            <td>{{ row['NON_LEGAL_FEAT_ID'] }}</td>
                            <td>{{ row['STRGC_LAND_RSRCE_PLAN_NAME'] }}</td>
                            <td>{{ row['NON_LEGAL_FEAT_OBJECTIVE'] }}</td>
                            <td>{{ row['ORIGINAL_DECISION_DATE'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No Non-Legal Planning Objective Points data found</p>
    {% endif %}

    {% if not intersected_data_1 and not intersected_data_2 and not intersected_data_3 and not intersected_data_4 and not
        intersected_data_5 and not intersected_data_6%}
        <p>No Data - Upload a file and intersect.</p>
    {% endif %}

    <!-- Add these two buttons to download separate CSVs -->
    {% if intersected_data_1 %}
        <button class="download-btn" onclick="downloadTableAsCSV('intersected-data-1-table', 'legal_data.csv')">Download Legal Planning Polygons CSV</button>
    {% endif %}
    {% if intersected_data_2 %}
        <button class="download-btn" onclick="downloadTableAsCSV('intersected-data-2-table', 'non_legal_data.csv')">Download Legal Planning Lines CSV</button>
    {% endif %}
    {% if intersected_data_3 %}
    <button class="download-btn" onclick="downloadTableAsCSV('intersected-data-3-table', 'legal_data.csv')">Download Legal Planning Points CSV</button>
    {% endif %}
    {% if intersected_data_4 %}
        <button class="download-btn" onclick="downloadTableAsCSV('intersected-data-4-table', 'non_legal_data.csv')">Download Non-Legal Planning Polygons CSV</button>
    {% endif %}
    {% if intersected_data_5 %}
        <button class="download-btn" onclick="downloadTableAsCSV('intersected-data-5-table', 'legal_data.csv')">Download Non-Legal Planning Lines CSV</button>
    {% endif %}
    {% if intersected_data_6 %}
        <button class="download-btn" onclick="downloadTableAsCSV('intersected-data-6-table', 'non_legal_data.csv')">Download Non-Legal Planning Points CSV</button>
    {% endif %}

    <div class="metadata-section">
        <h2 class="header-style">Gitanyow Lax’yip Land Use Plan (GLLUP) Area</h2>
        <p>The Gitanyow Lax’yip Land Use Plan (GLLUP) Area was supplied by <a href="https://native-land.ca/" target="_blank" class="link-style">Native Land</a></p>
        
        <h3 class="header-style">Disclaimer from Native lands</h3>
        <p>
            As stated on the front page of the Native Land website, the Native Land map does not represent or intend to represent official or legal boundaries of any Indigenous nations.
            You are free to use the dataset for your own maps and applications using the Native Land Digital API.
        </p>
    </div>

<script>
        var coll = document.getElementsByClassName("collapsible");
        var i;

        for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function () {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        }

        // JavaScript to toggle the visibility of the tables
        function toggleTableVisibility(tableId) {
            const tableContainer = document.getElementById(tableId);
            if (tableContainer.style.display === "none") {
                tableContainer.style.display = "block";
            } else {
                tableContainer.style.display = "none";
            }
        }

        function downloadTableAsCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            let csv = [];
            
            // Get the table headers
            const headers = [];
            const headerRow = table.querySelectorAll('th');
            headerRow.forEach(header => {
                headers.push(header.innerText);
            });
            csv.push(headers.join(',')); // Join headers as the first row
        
            // Get the table rows
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    let rowData = [];
                    cells.forEach(cell => {
                        rowData.push(cell.innerText);
                    });
                    csv.push(rowData.join(',')); // Join cells for each row
                }
            });
        
            // Create CSV file and trigger download
            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename); // Use the provided filename
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>

    <!-- Background Info Modal -->
    <div id="backgroundModal" class="modal">
        <div class="modal-content">
            <span class="close-background-modal">&times;</span>
            <h2>Gitanyow Lax'yip Land Use Plan (GLLUP) Background Info</h2>
            
            <p>The Gitanyow Lax'Yip Land Use Plan (GLLUP) is an outcome of collaboration between the Gitanyow Nation and the Province of BC dating back to the 1990's. The GLLUP is contained within Schedules A and B of the 2016 Gitanyow Huwilp Recognition and Reconciliation Agreement (RRA), an agreement between the Gitanyow Nation (Gitanyow Hereditary Chiefs and Gitanyow Huwilp Society) and the Province.</p>
            
            <p>The GLLUP covers the full extent of the Gitanyow Nation territory (Lax'yip) and overlaps with the following Provincial Land and Resource Management Plans (LRMPs) and Sustainable Resource Management Plans (SRMPs):</p>
            
            <ul>
                <li>Kalum LRMP</li>
                <li>Kalum SRMP</li>
                <li>Nass South SRMP</li>
                <li>Nass North SRMP</li>
                <li>Skeena LRMP</li>
                <li>Kispiox LRMP</li>
                <li>Kispiox SRMP</li>
                <li>Cranberry SRMP</li>
            </ul>
            
            <p>The LRMPs are high-level, strategic plans that guide the integrated management of different values and resources over large areas, whereas the SRMPs are more detailed, operational-level plans that implement the strategic direction set by LRMPs. The Kalum LRMP and Kalum SRMP as well as the Kispiox LRMP and SRMP were completed in 1996, 2001 and 2006 respectively. The Nass South SRMP and Cranberry SRMP were completed in 2012 alongside the GLLUP collaboration process.</p>
            
            <p>Unless otherwise indicated in the GLLUP, management goals, objectives, measures/indicators and targets apply throughout the Gitanyow Lax'yip. Where specified, planning units are referred to as the Cranberry, Kispiox, Nass South, or Kalum planning units and are co-extensive with the Provincial Sustainable Resource Management Planning areas with these names.</p>
            
            <p>The GLLUP fully integrates the management objectives and direction of these LRMPs/SRMPs and is fully consistent with them. While the GLLUP can be seen as Gitanyow's stand-alone land use plan, the legal enforcement of management objectives and direction currently rests with the SRMPs at this time.</p>
            
            <!-- Close button at the bottom -->
            <div style="text-align: center; margin-top: 20px;">
                <button id="closeModalBtn" class="close-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Background Modal Script -->
    <script src="../static/background-modal.js"></script>
    
    <!-- GeoJSON Display Script -->
    <script>
        // Add updateLegend function for intersection results
        function updateLegend(layerName, color, transparency, action) {
            const legendContent = document.getElementById("legendContent");
            const id = `legend-${layerName}`;
        
            if (action === "add") {
                if (document.getElementById(id)) return;
        
                const legendItem = document.createElement("div");
                legendItem.id = id;
                legendItem.style.display = "flex";
                legendItem.style.alignItems = "center";
                legendItem.style.marginBottom = "5px";
        
                const colorPatch = document.createElement("span");
                colorPatch.style.width = "20px";
                colorPatch.style.height = "20px";
                colorPatch.style.backgroundColor = color;
                colorPatch.style.opacity = transparency;
                colorPatch.style.border = "1px solid #000";
                colorPatch.style.marginRight = "10px";
        
                const layerLabel = document.createElement("span");
                layerLabel.textContent = layerName;
        
                legendItem.appendChild(colorPatch);
                legendItem.appendChild(layerLabel);
        
                legendContent.appendChild(legendItem);
            } else if (action === "remove") {
                const legendItem = document.getElementById(id);
                if (legendItem) legendContent.removeChild(legendItem);
            }
        }
        
        // Function to zoom to all intersection layers
        function zoomToIntersectionResults() {
            try {
                let allBounds = null;
                let layerCount = 0;
                
                // Collect bounds from all intersection layers
                Object.values(intersectionLayers).forEach(layer => {
                    if (layer && typeof layer.getBounds === 'function') {
                        const bounds = layer.getBounds();
                        if (bounds.isValid()) {
                            if (allBounds === null) {
                                allBounds = bounds;
                            } else {
                                allBounds.extend(bounds);
                            }
                            layerCount++;
                        }
                    }
                });
                
                // Zoom to combined bounds if we have layers
                if (allBounds && layerCount > 0) {
                    map.fitBounds(allBounds, {
                        padding: [20, 20], // Add some padding around the bounds
                        maxZoom: 16 // Don't zoom in too close
                    });
                    console.log(`Zoomed to ${layerCount} intersection layers`);
                } else {
                    console.log('No valid layers found for zooming');
                }
            } catch (e) {
                console.error('Error zooming to intersection results:', e);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Get the map instance from the embedded leaflet map
            // This assumes the map variable is available globally from lup_intersect.html
            console.log('Adding intersection results to map...');
            
            // Store references to intersection layers for toggling
            const intersectionLayers = {};
            
            // Function to add layer to checkbox container
            function addLayerCheckbox(layerName, layer, color) {
                const checkboxContainer = document.getElementById('checkbox-container');
                if (!checkboxContainer) return;
                
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.marginBottom = '5px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.id = `checkbox-${layerName.replace(/\s+/g, '-')}`;
                
                // Toggle layer and legend on checkbox change
                checkbox.onchange = function() {
                    if (this.checked) {
                        map.addLayer(layer);
                        if (typeof updateLegend === 'function') {
                            updateLegend(layerName, color, 0.8, 'add');
                        }
                    } else {
                        map.removeLayer(layer);
                        if (typeof updateLegend === 'function') {
                            updateLegend(layerName, color, 0.8, 'remove');
                        }
                    }
                };
                
                const span = document.createElement('span');
                span.textContent = ` ${layerName}`;
                span.style.marginLeft = '5px';
                
                label.appendChild(checkbox);
                label.appendChild(span);
                checkboxContainer.appendChild(label);
                
                console.log(`Added checkbox for ${layerName}`);
            }
            
            // Add uploaded AOI to map
            {% if uploaded_geojson %}
            try {
                var uploadedData = {{ uploaded_geojson|safe }};
                if (uploadedData && typeof map !== 'undefined') {
                    var uploadedLayer = L.geoJSON(uploadedData, {
                        style: {
                            color: '#FF0000',
                            weight: 3,
                            fillColor: '#FF0000',
                            fillOpacity: 0.2
                        },
                        onEachFeature: function(feature, layer) {
                            layer.bindPopup('<strong>Uploaded AOI</strong>');
                        }
                    }).addTo(map);
                    
                    // Store layer reference
                    intersectionLayers['uploadedAOI'] = uploadedLayer;
                    
                    // Add to legend
                    if (typeof updateLegend === 'function') {
                        updateLegend('Uploaded AOI', '#FF0000', 0.8, 'add');
                    }
                    
                    // Add checkbox for toggling
                    addLayerCheckbox('Intersected AOI', uploadedLayer, '#FF0000');
                    
                    // Zoom to uploaded layer bounds
                    map.fitBounds(uploadedLayer.getBounds());
                    console.log('Added uploaded AOI to map and zoomed to bounds');
                }
            } catch (e) {
                console.error('Error adding uploaded AOI to map:', e);
            }
            {% endif %}
            
            // Add intersection results to map
            {% if intersection_geojson %}
            
            // Legal Polygons
            {% if intersection_geojson.legal_polygons %}
            try {
                var legalPolygonsData = {{ intersection_geojson.legal_polygons|safe }};
                if (legalPolygonsData && typeof map !== 'undefined') {
                    var legalPolygonsLayer = L.geoJSON(legalPolygonsData, {
                        style: {
                            color: '#0000FF',
                            weight: 2,
                            fillColor: '#0000FF',
                            fillOpacity: 0.3
                        },
                        onEachFeature: function(feature, layer) {
                            var popupContent = '<strong>Legal Planning Objective Polygon</strong><br>';
                            if (feature.properties.LEGAL_FEAT_ID) {
                                popupContent += 'ID: ' + feature.properties.LEGAL_FEAT_ID + '<br>';
                            }
                            if (feature.properties.LEGAL_FEAT_OBJECTIVE) {
                                popupContent += 'Objective: ' + feature.properties.LEGAL_FEAT_OBJECTIVE;
                            }
                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);
                    
                    // Store layer reference
                    intersectionLayers['legalPolygons'] = legalPolygonsLayer;
                    
                    // Add to legend
                    if (typeof updateLegend === 'function') {
                        updateLegend('Legal Polygons', '#0000FF', 0.6, 'add');
                    }
                    
                    // Add checkbox for toggling
                    addLayerCheckbox('Intersected Legal Polygons', legalPolygonsLayer, '#0000FF');
                    
                    console.log('Added legal polygons to map');
                }
            } catch (e) {
                console.error('Error adding legal polygons to map:', e);
            }
            {% endif %}
            
            // Legal Lines
            {% if intersection_geojson.legal_lines %}
            try {
                var legalLinesData = {{ intersection_geojson.legal_lines|safe }};
                if (legalLinesData && typeof map !== 'undefined') {
                    var legalLinesLayer = L.geoJSON(legalLinesData, {
                        style: {
                            color: '#00FF00',
                            weight: 3
                        },
                        onEachFeature: function(feature, layer) {
                            var popupContent = '<strong>Legal Planning Objective Line</strong><br>';
                            if (feature.properties.LEGAL_FEAT_ID) {
                                popupContent += 'ID: ' + feature.properties.LEGAL_FEAT_ID + '<br>';
                            }
                            if (feature.properties.LEGAL_FEAT_OBJECTIVE) {
                                popupContent += 'Objective: ' + feature.properties.LEGAL_FEAT_OBJECTIVE;
                            }
                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);
                    
                    // Store layer reference
                    intersectionLayers['legalLines'] = legalLinesLayer;
                    
                    // Add to legend
                    if (typeof updateLegend === 'function') {
                        updateLegend('Legal Lines', '#00FF00', 1.0, 'add');
                    }
                    
                    // Add checkbox for toggling
                    addLayerCheckbox('Legal Lines', legalLinesLayer, '#00FF00');
                    
                    console.log('Added legal lines to map');
                }
            } catch (e) {
                console.error('Error adding legal lines to map:', e);
            }
            {% endif %}
            
            // Legal Points
            {% if intersection_geojson.legal_points %}
            try {
                var legalPointsData = {{ intersection_geojson.legal_points|safe }};
                if (legalPointsData && typeof map !== 'undefined') {
                    var legalPointsLayer = L.geoJSON(legalPointsData, {
                        pointToLayer: function(feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 6,
                                fillColor: '#FFFF00',
                                color: '#000000',
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            var popupContent = '<strong>Legal Planning Objective Point</strong><br>';
                            if (feature.properties.LEGAL_FEAT_ID) {
                                popupContent += 'ID: ' + feature.properties.LEGAL_FEAT_ID + '<br>';
                            }
                            if (feature.properties.LEGAL_FEAT_OBJECTIVE) {
                                popupContent += 'Objective: ' + feature.properties.LEGAL_FEAT_OBJECTIVE;
                            }
                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);
                    
                    // Store layer reference
                    intersectionLayers['legalPoints'] = legalPointsLayer;
                    
                    // Add to legend
                    if (typeof updateLegend === 'function') {
                        updateLegend('Legal Points', '#FFFF00', 0.8, 'add');
                    }
                    
                    // Add checkbox for toggling
                    addLayerCheckbox('Legal Points', legalPointsLayer, '#FFFF00');
                    
                    console.log('Added legal points to map');
                }
            } catch (e) {
                console.error('Error adding legal points to map:', e);
            }
            {% endif %}
            
            // Non-Legal Polygons
            {% if intersection_geojson.non_legal_polygons %}
            try {
                var nonLegalPolygonsData = {{ intersection_geojson.non_legal_polygons|safe }};
                if (nonLegalPolygonsData && typeof map !== 'undefined') {
                    var nonLegalPolygonsLayer = L.geoJSON(nonLegalPolygonsData, {
                        style: {
                            color: '#FF00FF',
                            weight: 2,
                            fillColor: '#FF00FF',
                            fillOpacity: 0.3
                        },
                        onEachFeature: function(feature, layer) {
                            var popupContent = '<strong>Non-Legal Planning Feature Polygon</strong><br>';
                            if (feature.properties.FEATURE_ID) {
                                popupContent += 'ID: ' + feature.properties.FEATURE_ID + '<br>';
                            }
                            if (feature.properties.FEATURE_NAME) {
                                popupContent += 'Name: ' + feature.properties.FEATURE_NAME;
                            }
                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);
                    
                    // Store layer reference
                    intersectionLayers['nonLegalPolygons'] = nonLegalPolygonsLayer;
                    
                    // Add to legend
                    if (typeof updateLegend === 'function') {
                        updateLegend('Non-Legal Polygons', '#FF00FF', 0.6, 'add');
                    }
                    
                    // Add checkbox for toggling
                    addLayerCheckbox('Intersected Non-Legal Polygons', nonLegalPolygonsLayer, '#FF00FF');
                    
                    console.log('Added non-legal polygons to map');
                }
            } catch (e) {
                console.error('Error adding non-legal polygons to map:', e);
            }
            {% endif %}
            
            // Non-Legal Lines
            {% if intersection_geojson.non_legal_lines %}
            try {
                var nonLegalLinesData = {{ intersection_geojson.non_legal_lines|safe }};
                if (nonLegalLinesData && typeof map !== 'undefined') {
                    var nonLegalLinesLayer = L.geoJSON(nonLegalLinesData, {
                        style: {
                            color: '#00FFFF',
                            weight: 3
                        },
                        onEachFeature: function(feature, layer) {
                            var popupContent = '<strong>Non-Legal Planning Feature Line</strong><br>';
                            if (feature.properties.FEATURE_ID) {
                                popupContent += 'ID: ' + feature.properties.FEATURE_ID + '<br>';
                            }
                            if (feature.properties.FEATURE_NAME) {
                                popupContent += 'Name: ' + feature.properties.FEATURE_NAME;
                            }
                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);
                    
                    // Store layer reference
                    intersectionLayers['nonLegalLines'] = nonLegalLinesLayer;
                    
                    // Add to legend
                    if (typeof updateLegend === 'function') {
                        updateLegend('Non-Legal Lines', '#00FFFF', 1.0, 'add');
                    }
                    
                    // Add checkbox for toggling
                    addLayerCheckbox('Intersected Non-Legal Lines', nonLegalLinesLayer, '#00FFFF');
                    
                    console.log('Added non-legal lines to map');
                }
            } catch (e) {
                console.error('Error adding non-legal lines to map:', e);
            }
            {% endif %}
            
            // Non-Legal Points
            {% if intersection_geojson.non_legal_points %}
            try {
                var nonLegalPointsData = {{ intersection_geojson.non_legal_points|safe }};
                if (nonLegalPointsData && typeof map !== 'undefined') {
                    var nonLegalPointsLayer = L.geoJSON(nonLegalPointsData, {
                        pointToLayer: function(feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 6,
                                fillColor: '#FFA500',
                                color: '#000000',
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        },
                        onEachFeature: function(feature, layer) {
                            var popupContent = '<strong>Non-Legal Planning Feature Point</strong><br>';
                            if (feature.properties.FEATURE_ID) {
                                popupContent += 'ID: ' + feature.properties.FEATURE_ID + '<br>';
                            }
                            if (feature.properties.FEATURE_NAME) {
                                popupContent += 'Name: ' + feature.properties.FEATURE_NAME;
                            }
                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);
                    
                    // Store layer reference
                    intersectionLayers['nonLegalPoints'] = nonLegalPointsLayer;
                    
                    // Add to legend
                    if (typeof updateLegend === 'function') {
                        updateLegend('Non-Legal Points', '#FFA500', 0.8, 'add');
                    }
                    
                    // Add checkbox for toggling
                    addLayerCheckbox('Intersected Non-Legal Points', nonLegalPointsLayer, '#FFA500');
                    
                    console.log('Added non-legal points to map');
                }
            } catch (e) {
                console.error('Error adding non-legal points to map:', e);
            }
            {% endif %}
            
            {% endif %}
            
            // After all layers are loaded, zoom to show all intersection results
            setTimeout(function() {
                zoomToIntersectionResults();
            }, 500); // Small delay to ensure all layers are fully rendered
            
        });
    </script>

    <script>
        // Loading spinner functionality
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[action="/intersect"]');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            if (form && loadingOverlay) {
                form.addEventListener('submit', function(e) {
                    // Validate that either a file or URL is provided
                    const fileInput = document.getElementById('file-upload');
                    const urlInput = document.getElementById('url-input');
                    const dataTypeInputs = document.querySelectorAll('input[name="data_type"]');
                    
                    let hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
                    let hasUrl = urlInput && urlInput.value && urlInput.value.trim() !== '';
                    let hasDataType = dataTypeInputs && Array.from(dataTypeInputs).some(input => input.checked);
                    
                    console.log('Form validation:', {
                        hasFile: hasFile,
                        hasUrl: hasUrl,
                        hasDataType: hasDataType,
                        fileInput: fileInput,
                        urlInput: urlInput,
                        dataTypeInputs: dataTypeInputs.length
                    });
                    
                    if (!hasFile && !hasUrl) {
                        alert('Please select a file or enter a URL');
                        e.preventDefault();
                        return false;
                    }
                    
                    if (!hasDataType) {
                        alert('Please select a data type (Legal, Non-legal, or Both)');
                        e.preventDefault();
                        return false;
                    }
                    
                    // Show loading spinner
                    loadingOverlay.style.display = 'flex';
                    
                    // Don't disable form elements - let the form submit naturally
                    // The loading spinner will show the processing state
                });
            }
            
            // Hide loading spinner on page load (in case of back button or error)
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        });
    </script>
</body>
</html>
